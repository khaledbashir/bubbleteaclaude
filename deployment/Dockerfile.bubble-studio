FROM node:20-slim AS builder
RUN corepack enable
WORKDIR /workspace

# Copy workspace files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages ./packages/
COPY apps/bubble-studio ./apps/bubble-studio/
COPY tools ./tools/
COPY .npmrc ./. 

# Install all dependencies
RUN pnpm install --frozen-lockfile

ARG VITE_API_URL=https://bubble-bubble.5jtgcw.easypanel.host
ARG VITE_CLERK_PUBLISHABLE_KEY=
ARG VITE_DISABLE_AUTH=true
ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_CLERK_PUBLISHABLE_KEY=${VITE_CLERK_PUBLISHABLE_KEY}
ENV VITE_DISABLE_AUTH=${VITE_DISABLE_AUTH}
# Build dependencies
RUN cd packages/bubble-shared-schemas && pnpm run build
RUN cd packages/bubble-core && pnpm run build
RUN cd apps/bubble-studio && pnpm run build

# Runtime stage - use nginx to serve static files directly
FROM nginx:alpine
# Copy static files to nginx html directory
# Note: dist folder contains index.html and assets, so copy its contents
COPY --from=builder /workspace/apps/bubble-studio/dist /usr/share/nginx/html
EXPOSE 80

